name: Deploy Homologação RIDI Backend

on:
  push:
    branches:
      - main

jobs:
  deploy-hml:
    name: Deploy em Homologação
    runs-on: [self-hosted, hml-ridi-backend, Linux, X64]

    steps:
      - name: Checkout código do repositório
        uses: actions/checkout@v4

      - name: Compilar o backend RIDI
        run: mvn clean package -DskipTests

      - name: Atualizar DSpace
        run: |
          cd dspace/target/dspace-installer
          ant update

      - name: Reiniciar RIDI
        run: |
          if systemctl list-units --type=service | grep -q "ridi.service"; then
            echo "🔁 Reiniciando serviço ridi.service..."
            sudo systemctl restart ridi.service
          else
            echo "⚙️ Executando manualmente o backend RIDI..."
            pkill -f "ridi.jar" || true
            nohup java -jar /dspace/ridi/ridi.jar --server.port=8081 > /dspace/ridi/ridi.log 2>&1 &
          fi
